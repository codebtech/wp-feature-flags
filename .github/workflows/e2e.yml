name: E2E Tests
on: [push]

jobs:
    test:
        timeout-minutes: 60
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                php-versions: ['8.3']
        env:
            WP_BASE_URL: 'http://localhost:8888'
            WP_USERNAME: 'admin'
            WP_PASSWORD: 'password'
            WP_AUTH_STORAGE: '.auth/wordpress.json'
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: '20.11'

            - name: Cache Composer dependencies
              uses: actions/cache@v4
              with:
                  path: /tmp/composer-cache
                  key: ${{ runner.os }}-${{ hashFiles('**/composer.lock') }}

            - name: Setup composer
              uses: php-actions/composer@v6
              with:
                  php_version: ${{ matrix.php-versions }}
                  dev: no

            - name: Install packages
              run: yarn install --immutable

            - name: Playwright install
              run: yarn playwright install

            - name: Start wp-env
              run: yarn wp-env

            - name: Run Playwright tests
              run: npx playwright test --reporter=github

            - uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30
